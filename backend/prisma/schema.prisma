// Prisma Schema for GST Compliance SaaS
// This is the initial schema - will be expanded in Week 1-2

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Model (Week 2: Authentication)
model User {
  id                    String    @id @default(uuid())
  email                 String    @unique
  passwordHash          String    @map("password_hash")
  emailVerified         Boolean   @default(false) @map("email_verified")
  emailVerificationToken String?  @map("email_verification_token")
  passwordResetToken    String?   @map("password_reset_token")
  passwordResetExpires  DateTime? @map("password_reset_expires")
  role                  String    @default("owner") // owner, accountant, viewer
  isActive              Boolean   @default(true) @map("is_active")
  lastLogin             DateTime? @map("last_login")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  deletedAt             DateTime? @map("deleted_at")

  // Relations
  businesses Business[]

  @@index([email])
  @@index([isActive])
  @@map("users")
}

// Business Model (Week 2: Business Setup)
model Business {
  id               String    @id @default(uuid())
  userId           String    @map("user_id")
  
  // Business Details
  businessName     String    @map("business_name")
  tradeName        String?   @map("trade_name")
  businessType     String    @map("business_type") // regular, composition, sez, export
  
  // GST Details (CRITICAL)
  gstin            String    @unique
  pan              String
  stateCode        String    @map("state_code")
  registrationDate DateTime  @map("registration_date")
  
  // Address
  addressLine1     String    @map("address_line1")
  addressLine2     String?   @map("address_line2")
  city             String
  state            String
  pincode          String
  
  // Contact
  email            String?
  phone            String?
  website          String?
  
  // Bank Details
  bankName         String?   @map("bank_name")
  bankAccountNumber String?  @map("bank_account_number")
  bankIfsc         String?   @map("bank_ifsc")
  bankBranch       String?   @map("bank_branch")
  
  // GST Configuration
  filingFrequency  String    @default("monthly") @map("filing_frequency") // monthly, quarterly
  financialYearStart String  @default("04-01") @map("financial_year_start")
  
  // Branding
  logoUrl          String?   @map("logo_url")
  
  // Subscription
  subscriptionPlan String    @default("free_trial") @map("subscription_plan")
  subscriptionStatus String  @default("active") @map("subscription_status")
  subscriptionValidUntil DateTime? @map("subscription_valid_until")
  invoiceLimit     Int       @default(100) @map("invoice_limit")
  invoiceCountCurrentMonth Int @default(0) @map("invoice_count_current_month")
  
  // Metadata
  isActive         Boolean   @default(true) @map("is_active")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  deletedAt        DateTime? @map("deleted_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  customers Customer[]
  invoices Invoice[]
  suppliers Supplier[]
  purchases Purchase[]
  gstReturns GSTReturn[]
  payments Payment[]

  @@index([userId])
  @@index([gstin])
  @@index([isActive])
  @@map("businesses")
}

// Customer Model (Week 3: Customer Management)
model Customer {
  id               String    @id @default(uuid())
  businessId       String    @map("business_id")
  
  // Customer Details
  customerName     String    @map("customer_name")
  gstin            String?   // Optional for B2C customers
  pan              String?
  billingAddress   String    @map("billing_address")
  shippingAddress  String?   @map("shipping_address") // Optional, defaults to billing address
  city             String
  state            String
  stateCode        String?   @map("state_code") // Extracted from GSTIN if available
  pincode          String
  contactPerson    String?   @map("contact_person") // Optional contact person name
  
  // Contact
  email            String?
  phone            String?
  
  // Customer Type
  customerType     String    @default("b2b") @map("customer_type") // b2b, b2c, export, sez
  
  // Metadata
  isActive         Boolean   @default(true) @map("is_active")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  deletedAt        DateTime? @map("deleted_at")
  
  // Relations
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  invoices Invoice[]
  
  @@index([businessId])
  @@index([gstin])
  @@index([customerType])
  @@index([isActive])
  @@map("customers")
}

// Invoice Model (Week 3: Invoice Management)
model Invoice {
  id                    String    @id @default(uuid())
  businessId            String    @map("business_id")
  customerId            String    @map("customer_id")
  
  // Invoice Details
  invoiceNumber         String    @map("invoice_number")
  invoiceDate           DateTime  @map("invoice_date")
  invoiceType           String    @map("invoice_type") // b2b, b2c_large, b2c_small, export, sez
  
  // Financial Details
  subtotal              Decimal   @db.Decimal(12, 2)
  discountAmount        Decimal   @default(0) @map("discount_amount") @db.Decimal(12, 2)
  taxableAmount         Decimal   @map("taxable_amount") @db.Decimal(12, 2)
  
  // GST Breakdown (CRITICAL)
  cgstAmount            Decimal   @default(0) @map("cgst_amount") @db.Decimal(12, 2)
  sgstAmount            Decimal   @default(0) @map("sgst_amount") @db.Decimal(12, 2)
  igstAmount            Decimal   @default(0) @map("igst_amount") @db.Decimal(12, 2)
  cessAmount            Decimal   @default(0) @map("cess_amount") @db.Decimal(12, 2)
  totalTaxAmount        Decimal   @map("total_tax_amount") @db.Decimal(12, 2)
  
  // Total
  totalAmount           Decimal   @map("total_amount") @db.Decimal(12, 2)
  roundOffAmount        Decimal   @default(0) @map("round_off_amount") @db.Decimal(12, 2)
  
  // State Information (for GST calculation)
  sellerState           String    @map("seller_state")
  sellerStateCode       String    @map("seller_state_code")
  buyerState            String    @map("buyer_state")
  buyerStateCode        String?   @map("buyer_state_code")
  
  // Additional Details
  placeOfSupply         String    @map("place_of_supply")
  reverseCharge         Boolean   @default(false) @map("reverse_charge")
  notes                 String?
  termsAndConditions    String?   @map("terms_and_conditions")
  
  // GSTR Filing Status
  filedInGstr1          Boolean   @default(false) @map("filed_in_gstr1")
  gstr1FilingMonth      String?   @map("gstr1_filing_month") // Format: "YYYY-MM"
  
  // PDF Generation (Week 9-10)
  pdfGenerated          Boolean   @default(false) @map("pdf_generated")
  pdfFilePath           String?   @map("pdf_file_path")
  pdfGeneratedAt        DateTime? @map("pdf_generated_at")
  
  // Email Status (Week 9-10)
  emailSent             Boolean   @default(false) @map("email_sent")
  emailSentTo           String?   @map("email_sent_to")
  emailSentAt           DateTime? @map("email_sent_at")
  emailSubject          String?   @map("email_subject")
  
  // Metadata
  isActive              Boolean   @default(true) @map("is_active")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  deletedAt             DateTime? @map("deleted_at")
  
  // Relations
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  customer Customer @relation(fields: [customerId], references: [id])
  items    InvoiceItem[]
  
  @@unique([businessId, invoiceNumber])
  @@index([businessId])
  @@index([customerId])
  @@index([invoiceDate])
  @@index([invoiceType])
  @@index([filedInGstr1])
  @@map("invoices")
}

// Invoice Item Model (Week 3: Invoice Line Items)
model InvoiceItem {
  id                String   @id @default(uuid())
  invoiceId         String   @map("invoice_id")
  
  // Item Details
  itemName          String   @map("item_name")
  description       String?
  hsnCode           String?  @map("hsn_code") // HSN for goods
  sacCode           String?  @map("sac_code") // SAC for services
  
  // Quantity & Price
  quantity          Decimal  @db.Decimal(10, 3)
  unit              String   @default("NOS") // NOS, KG, LITER, etc.
  unitPrice         Decimal  @map("unit_price") @db.Decimal(12, 2)
  
  // Discount
  discountPercent   Decimal  @default(0) @map("discount_percent") @db.Decimal(5, 2)
  discountAmount    Decimal  @default(0) @map("discount_amount") @db.Decimal(12, 2)
  
  // Taxable Amount
  taxableAmount     Decimal  @map("taxable_amount") @db.Decimal(12, 2)
  
  // GST Rate
  gstRate           Decimal  @map("gst_rate") @db.Decimal(5, 2) // 5, 12, 18, 28
  
  // GST Breakdown
  cgstRate          Decimal  @default(0) @map("cgst_rate") @db.Decimal(5, 2)
  cgstAmount        Decimal  @default(0) @map("cgst_amount") @db.Decimal(12, 2)
  sgstRate          Decimal  @default(0) @map("sgst_rate") @db.Decimal(5, 2)
  sgstAmount        Decimal  @default(0) @map("sgst_amount") @db.Decimal(12, 2)
  igstRate          Decimal  @default(0) @map("igst_rate") @db.Decimal(5, 2)
  igstAmount        Decimal  @default(0) @map("igst_amount") @db.Decimal(12, 2)
  cessRate          Decimal  @default(0) @map("cess_rate") @db.Decimal(5, 2)
  cessAmount        Decimal  @default(0) @map("cess_amount") @db.Decimal(12, 2)
  
  // Total
  totalAmount       Decimal  @map("total_amount") @db.Decimal(12, 2)
  
  // Metadata
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  // Relations
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  @@index([invoiceId])
  @@index([hsnCode])
  @@index([sacCode])
  @@map("invoice_items")
}

// Supplier Model (Week 5: Purchase Management)
model Supplier {
  id               String    @id @default(uuid())
  businessId       String    @map("business_id")
  
  // Supplier Details
  supplierName     String    @map("supplier_name")
  gstin            String?   // Optional for unregistered suppliers
  pan              String?
  billingAddress   String    @map("billing_address")
  city             String
  state            String
  stateCode        String?   @map("state_code") // Extracted from GSTIN if available
  pincode          String
  
  // Contact
  email            String?
  phone            String?
  
  // Supplier Type
  supplierType     String    @default("registered") @map("supplier_type") // registered, unregistered, composition
  
  // Metadata
  isActive         Boolean   @default(true) @map("is_active")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  deletedAt        DateTime? @map("deleted_at")
  
  // Relations
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  purchases Purchase[]
  
  @@index([businessId])
  @@index([gstin])
  @@index([supplierType])
  @@index([isActive])
  @@map("suppliers")
}

// Purchase Invoice Model (Week 5: Purchase Management)
model Purchase {
  id                    String    @id @default(uuid())
  businessId            String    @map("business_id")
  supplierId            String    @map("supplier_id")
  
  // Invoice Details (from supplier's invoice)
  supplierInvoiceNumber String    @map("supplier_invoice_number")
  supplierInvoiceDate   DateTime  @map("supplier_invoice_date")
  purchaseType          String    @map("purchase_type") // goods, services, capital_goods, import
  
  // Financial Details
  subtotal              Decimal   @db.Decimal(12, 2)
  discountAmount        Decimal   @default(0) @map("discount_amount") @db.Decimal(12, 2)
  taxableAmount         Decimal   @map("taxable_amount") @db.Decimal(12, 2)
  
  // GST Breakdown (CRITICAL for ITC)
  cgstAmount            Decimal   @default(0) @map("cgst_amount") @db.Decimal(12, 2)
  sgstAmount            Decimal   @default(0) @map("sgst_amount") @db.Decimal(12, 2)
  igstAmount            Decimal   @default(0) @map("igst_amount") @db.Decimal(12, 2)
  cessAmount            Decimal   @default(0) @map("cess_amount") @db.Decimal(12, 2)
  totalTaxAmount        Decimal   @map("total_tax_amount") @db.Decimal(12, 2)
  
  // Total
  totalAmount           Decimal   @map("total_amount") @db.Decimal(12, 2)
  
  // State Information (for GST calculation)
  supplierState         String    @map("supplier_state")
  supplierStateCode     String?   @map("supplier_state_code")
  buyerState            String    @map("buyer_state")
  buyerStateCode        String    @map("buyer_state_code")
  
  // ITC (Input Tax Credit) - CRITICAL
  isItcEligible         Boolean   @default(true) @map("is_itc_eligible")
  itcClaimType          String    @default("full") @map("itc_claim_type") // full, partial, none
  itcAmount             Decimal   @default(0) @map("itc_amount") @db.Decimal(12, 2)
  
  // Additional Details
  placeOfSupply         String    @map("place_of_supply")
  reverseCharge         Boolean   @default(false) @map("reverse_charge")
  notes                 String?
  
  // GSTR Filing Status
  filedInGstr2          Boolean   @default(false) @map("filed_in_gstr2")
  gstr2FilingMonth      String?   @map("gstr2_filing_month") // Format: "YYYY-MM"
  matchedInGstr2a       Boolean   @default(false) @map("matched_in_gstr2a") // Auto-matched with GSTR-2A
  
  // Payment Status
  isPaid                Boolean   @default(false) @map("is_paid")
  paymentDate           DateTime? @map("payment_date")
  paymentMethod         String?   @map("payment_method")
  
  // Metadata
  isActive              Boolean   @default(true) @map("is_active")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  deletedAt             DateTime? @map("deleted_at")
  
  // Relations
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  supplier Supplier @relation(fields: [supplierId], references: [id])
  items    PurchaseItem[]
  
  @@unique([businessId, supplierInvoiceNumber, supplierId])
  @@index([businessId])
  @@index([supplierId])
  @@index([supplierInvoiceDate])
  @@index([purchaseType])
  @@index([isItcEligible])
  @@index([filedInGstr2])
  @@map("purchases")
}

// Purchase Item Model (Week 5: Purchase Line Items)
model PurchaseItem {
  id                String   @id @default(uuid())
  purchaseId        String   @map("purchase_id")
  
  // Item Details
  itemName          String   @map("item_name")
  description       String?
  hsnCode           String?  @map("hsn_code") // HSN for goods
  sacCode           String?  @map("sac_code") // SAC for services
  
  // Quantity & Price
  quantity          Decimal  @db.Decimal(10, 3)
  unit              String   @default("NOS") // NOS, KG, LITER, etc.
  unitPrice         Decimal  @map("unit_price") @db.Decimal(12, 2)
  
  // Discount
  discountPercent   Decimal  @default(0) @map("discount_percent") @db.Decimal(5, 2)
  discountAmount    Decimal  @default(0) @map("discount_amount") @db.Decimal(12, 2)
  
  // Taxable Amount
  taxableAmount     Decimal  @map("taxable_amount") @db.Decimal(12, 2)
  
  // GST Rate
  gstRate           Decimal  @map("gst_rate") @db.Decimal(5, 2)
  
  // GST Breakdown
  cgstRate          Decimal  @default(0) @map("cgst_rate") @db.Decimal(5, 2)
  cgstAmount        Decimal  @default(0) @map("cgst_amount") @db.Decimal(12, 2)
  sgstRate          Decimal  @default(0) @map("sgst_rate") @db.Decimal(5, 2)
  sgstAmount        Decimal  @default(0) @map("sgst_amount") @db.Decimal(12, 2)
  igstRate          Decimal  @default(0) @map("igst_rate") @db.Decimal(5, 2)
  igstAmount        Decimal  @default(0) @map("igst_amount") @db.Decimal(12, 2)
  cessRate          Decimal  @default(0) @map("cess_rate") @db.Decimal(5, 2)
  cessAmount        Decimal  @default(0) @map("cess_amount") @db.Decimal(12, 2)
  
  // ITC Eligibility (item-level)
  isItcEligible     Boolean  @default(true) @map("is_itc_eligible")
  itcAmount         Decimal  @default(0) @map("itc_amount") @db.Decimal(12, 2)
  
  // Total
  totalAmount       Decimal  @map("total_amount") @db.Decimal(12, 2)
  
  // Metadata
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  // Relations
  purchase Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  
  @@index([purchaseId])
  @@index([hsnCode])
  @@index([sacCode])
  @@map("purchase_items")
}

// GST Return Model (Week 7-8: GSTR-1 & GSTR-3B)
model GSTReturn {
  id                String    @id @default(uuid())
  businessId        String    @map("business_id")
  
  // Return Details
  returnType        String    @map("return_type") // gstr1, gstr3b, gstr2a, gstr2b
  filingPeriod      String    @map("filing_period") // Format: "YYYY-MM" (e.g., "2026-01")
  financialYear     String    @map("financial_year") // Format: "2025-2026"
  
  // Return Data (JSON)
  returnData        Json      @map("return_data") // Complete return data in JSON format
  
  // Summary Fields
  totalTaxLiability Decimal?  @map("total_tax_liability") @db.Decimal(12, 2)
  totalItc          Decimal?  @map("total_itc") @db.Decimal(12, 2)
  netTaxPayable     Decimal?  @map("net_tax_payable") @db.Decimal(12, 2)
  interestPayable   Decimal?  @default(0) @map("interest_payable") @db.Decimal(12, 2)
  lateFeesPayable   Decimal?  @default(0) @map("late_fees_payable") @db.Decimal(12, 2)
  
  // Filing Status
  status            String    @default("draft") // draft, generated, validated, filed, accepted, rejected
  generatedAt       DateTime? @map("generated_at")
  filedAt           DateTime? @map("filed_at")
  acknowledgeNumber String?   @map("acknowledge_number") // ARN from GST Portal
  
  // Validation
  validationErrors  Json?     @map("validation_errors") // Array of validation errors
  isValid           Boolean   @default(false) @map("is_valid")
  
  // Export Files
  jsonFilePath      String?   @map("json_file_path") // Path to exported JSON file
  excelFilePath     String?   @map("excel_file_path") // Path to exported Excel file
  
  // Metadata
  notes             String?
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  deletedAt         DateTime? @map("deleted_at")
  
  // Relations
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  @@unique([businessId, returnType, filingPeriod])
  @@index([businessId])
  @@index([returnType])
  @@index([filingPeriod])
  @@index([status])
  @@map("gst_returns")
}

// Payment Model (Week 11-12: Subscription & Payments)
model Payment {
  id                     String    @id @default(uuid())
  businessId             String    @map("business_id")
  
  // Payment Details
  paymentType            String    @map("payment_type") // subscription, addon, refund
  planId                 String    @map("plan_id") // starter, professional, enterprise
  billingCycle           String    @map("billing_cycle") // monthly, annual
  
  // Amounts
  amount                 Decimal   @map("amount") @db.Decimal(10, 2)
  currency               String    @default("INR")
  gstAmount              Decimal   @default(0) @map("gst_amount") @db.Decimal(10, 2)
  totalAmount            Decimal   @map("total_amount") @db.Decimal(10, 2)
  
  // Razorpay Details
  razorpayOrderId        String?   @unique @map("razorpay_order_id")
  razorpayPaymentId      String?   @unique @map("razorpay_payment_id")
  razorpaySignature      String?   @map("razorpay_signature")
  
  // Payment Status
  status                 String    @default("created") // created, authorized, captured, failed, refunded
  paymentMethod          String?   @map("payment_method") // card, netbanking, upi, wallet
  
  // Subscription Period
  subscriptionStartDate  DateTime? @map("subscription_start_date")
  subscriptionEndDate    DateTime? @map("subscription_end_date")
  
  // Receipt & Invoice
  receiptNumber          String?   @unique @map("receipt_number")
  invoiceUrl             String?   @map("invoice_url")
  
  // Failure/Error Details
  failureReason          String?   @map("failure_reason")
  errorCode              String?   @map("error_code")
  errorDescription       String?   @map("error_description")
  
  // Refund Details (if applicable)
  refundId               String?   @map("refund_id")
  refundAmount           Decimal?  @map("refund_amount") @db.Decimal(10, 2)
  refundedAt             DateTime? @map("refunded_at")
  
  // Metadata
  metadata               Json?     // Additional payment data
  notes                  String?
  createdAt              DateTime  @default(now()) @map("created_at")
  updatedAt              DateTime  @updatedAt @map("updated_at")
  
  // Relations
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  @@index([businessId])
  @@index([status])
  @@index([paymentType])
  @@index([razorpayOrderId])
  @@index([razorpayPaymentId])
  @@index([createdAt])
  @@map("payments")
}

// TODO: Add more models in future weeks
// - AuditLog (track all changes)
// - Notification (email/SMS notifications)
// - Webhook (external integrations)

// See docs/02-DATABASE-SCHEMA.md for complete schema
